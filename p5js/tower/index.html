<script src="node_modules/p5/lib/p5.js"></script>
<script src="node_modules/rainbowvis.js/rainbowvis.js"></script>
<style>
    /* canvas{
        width: 640px;
        height: 640px;
    } */
</style>

<body></body>
<script src="node_modules/ccapture.js/build/CCapture.all.min.js"></script>
<script>
    var canvas;
    var rainbow = new Rainbow();
    var max_frame = 5;

    function setup() {
        createCanvas(800, 800);
        canvas = document.getElementById('defaultCanvas0');
        strokeWeight(2);
        startCapture();
    }

    var r_circles;
    var circles = [];
    var c_limit = (25.5 * 2);
    var time = 1000 * Math.random();

    function draw() {
        background(200);

        circles.push(createCircle({ x: 400, y: 360 }, 120, 70));
        if (circles.length > c_limit) {
            circles.shift();
        }

        r_circles = JSON.parse(JSON.stringify(circles));
        r_circles.reverse();
        for (var r = 0; r < r_circles.length; r++) {
            var _circle = r_circles[r];
            // _circle.reverse();

            for (var p = 0; p < _circle.length; p++) {
                var _point = _circle[p];
                var n_point = _circle[p + 1];
                if (!n_point) {
                    n_point = _circle[0];
                }

                var op_color = 'rgba(10,10,10,' + ((1 - (r / r_circles.length))).toFixed(2) + ')';
                // console.log(op_color)
                stroke(op_color);
                line(
                    _point.x, _point.y + r * 5,
                    n_point.x, n_point.y + r * 5
                );
            }
        }

        time += .05;
    }

    function createCircle(center, radius, precision) {
        var coordinates = [];
        var middle = precision / 2;

        for (var i = 0; i < precision; i++) {
            var angle = (i / (precision / 2)) * PI;
            var n = noise((i * HALF_PI + (time * 8)) / (precision / 1.6));
            var x = center.x + (radius * Math.cos(angle)) * (((n * HALF_PI) / 1.2) * 2);
            var y = center.y + (radius * Math.sin(angle)) * (n * 2);

            // // if(i > middle){
            //     var rx = center.x + (radius * Math.cos(angle));
            //     var ry = center.y + (radius * Math.sin(angle));

            //     if(x > rx){
            //         x -= ((x - rx) / ((i - precision) * -1) / 8);
            //     }
            //     else{
            //         x += ((rx - x) / ((i - precision) * -1) / 8);
            //     }

            //     if(y > ry){
            //         y += ((y - ry) / ((i - precision) * -1) / 8);
            //     }
            //     else{
            //         y -= ((rx - y) / ((i - precision) * -1) / 8);
            //     }
            // // }

            coordinates.push({ x: x, y: y });
        }
        return coordinates;
    }

    var framerate = 24;
    var motion_blur = 1;
    var capturer = new CCapture({
        format: 'webm',
        framerate: framerate,
        workersPath: 'node_modules/ccapture.js/src/',
        // verbose: true,
        motionBlurFrames: motion_blur
    });

    var time_stop = 20 * 1000;
    var total = (time_stop / 1000) * (framerate * (motion_blur));
    var rendered_count = 0;
    var stop = false;
    var saved = false;
    function startCapture() {
        rendered_count = 0;
        capturer.start();
        render();
        setTimeout(function () {
            stop = true;
            if (saved !== true) {
                capturer.stop();
                capturer.save();
                saved = true;
            }
        }, time_stop);
    }

    function render() {
        if (stop === false) {
            capturer.capture(canvas);
            rendered_count++;
            console.log('Render process: ' + ((rendered_count / total) * 100).toFixed(2) + '%');
            requestAnimationFrame(render);
        }
    }
</script>